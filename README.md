# hydro-model-xaj

新安江水文模型
**正在开发中**......
下面各个公式的推导过程打出来还是有些麻烦，这里就主要以文字为主进行介绍了，如果**有人 star 或者 fork 这个项目**的话，我就把下面算法里的公式的推导过程打出来。

## 项目介绍

根据中国水利水电出版社出版的，由武汉大学叶守泽老师和河海大学詹道江老师等合编的《工程水文学》第三版教材中新安江模型的原理，结合河海大学芮孝芳老师《水文学原理》中的相关知识，编写的新安江三水源模型的 python 版本。

## 主要内容

### 数据处理：

采用 txt 格式作为首选，适合 nc 格式的地方也尝试使用 nc 数据格式，比如有经纬度的时间序列数据——雷达测雨数据等。原因可以参考：[Python programming guide for Earth Scientists](http://python.hydrology-amsterdam.nl/manuals/hydro_python_manual.pdf)。nc 格式数据 python 接口官方资料：[netcdf4-python](https://github.com/Unidata/netcdf4-python)，补充一些资料如下：[Generating NetCDF files with Python](http://www.ceda.ac.uk/static/media/uploads/ncas-reading-2015/11_create_netcdf_python.pdf)；[Python-NetCDF reading and writing example with plotting](http://schubert.atmos.colostate.edu/~cslocum/netcdf_example.html)。

### 新安江模型核心算法

#### 前期土壤含水量计算

在进行产流计算之前，首先需要计算前期土壤蓄水容量。利用前期降雨蒸发数据，采用流域蒸发计算模型逐日计算。

- 当降雨 P 大于蒸发 E，即 P-E=PE>0。
  说明流域蓄水量增加，这部分增加的水量在流域蒸发模型中，首先被用来补充上层土壤水，在流域上层蓄水量达到最大值后，再补充下层，同理最后补充深层。在判断表层水是否补充充足时，需要计算产流量 R，产流量计算遵循蓄满产流原理（见下一小节）。在整个过程中，只有表层有蒸散发，且按蒸散发能力蒸发，K 是折算系数，EM 是实测的水面蒸发值，下层和深层为 0。
- 当 PE<0 时。
  说明流域失水，那么首先蒸发上层水，按上层蒸发能力蒸发，上层蒸发完之后再消耗下层的含水量，下层的蒸发量与下层含水量成正比，与蓄水容量成反比，在两层蒸发模型中根据剩余蒸发量，按比例直接计算可得。但是，**当下层含水量与下层蓄水容量之比小于深层蒸散发系数 C 时**，需要利用三层蒸发模型。

上面一段蒸发为什么这么计算，书上没有解释，_个人理解_：
下层含水量与下层蓄水容量之比小于深层蒸散发系数 C，深层蒸散发系数可以理解为深层蒸发量和深层蒸发能力之比，同样假设其等于深层含水量与深层蓄水容量之比，那么下层含水量与下层蓄水容量之比理解为下层蒸散发系数，也就是说下层蒸散发系数小于深层时，深层水应该承担一部分的蒸发量。但是如果下层也按深层的蒸散发系数蒸发，可以承担剩余的蒸发量，那就不需要深层水了。这里推理一下，应该是认为*下层水的蒸散发系数不是定值，看下层含水量情况以及和深层蒸散发系数比较的情况*，因为C$\times$WLM标识了**毛管断裂含水量**，因此当下层含水/下层蓄水容量 大于深层蒸散发系数时，可以认为下层土壤的水分输移是稳定的，下层含水量是可以一直有深层补充的，即下层和深层是关联的，因此采用二层蒸发模型即可；或者就算小，但是因为C$\times$(EP-EU)标识了**土壤水的扩散能力**，按照深层蒸散发系数蒸发也能满足除去表层蒸发之后的蒸发量时，同样可以认为深层水和下层水是联系的；如果不满足这两种情况，那就说明深层水到下层水的输移已经打断，需要深层水独立分担一部分了。

最后汇总三层蒸发和三层蓄水。

整体计算流程图如下所示：

1. PE>=0 时

```flow
st=>start: 执行
sub=>subroutine: 计算R
cond2=>condition: WU+PE-R>WUM
op2=>operation: WU=WU+PE-R
cond3=>condition: WU+PE-R-WUM+WL>WLM
op3=>operation: WU=WUM,WL=WLM,WD=W+PE-R-WU-WL
op4=>operation: WU=WUM,WL=WU+WL+PE-R-WUM
op5=>operation: EU=K*EM,ED=EL=0
io=>inputoutput: E=EU+EL+ED,W=WU+WL+WD
e=>end: 结束

st->sub->cond2
cond2(yes)->cond3
cond2(no)->op2->op5
cond3(yes)->op3->op5
cond3(no)->op4->op5
op5->io->e
```

2. PE<0 时

```flow
st=>start: 执行
cond4=>condition: WU>PE
op7=>operation: EU=K*EM,EL=ED=0,WU=WU+PE
op12=>operation: .
op8=>operation: EU=WU+P,WU=0
cond5=>condition: WL>C*WLM
op9=>operation: EL=(K*EM-EU)*WL/WLM,WL=WL-EL,ED=0
cond6=>condition: WL>C*(K*EM-EU)
op10=>operation: EL=C*(K*EM-EU),WL=WL-EL,ED=0
op11=>operation: EL=WL,WL=0,ED=C*(K*EM-EU)-EL,WD=WD-ED
io=>inputoutput: E=EU+EL+ED,W=WU+WL+WD
e=>end: 结束

st->cond4
cond4(yes)->op7->op12->io
cond4(no)->op8->cond5
cond5(yes)->op9->io
cond5(no)->cond6
cond6(yes)->op10->io
cond6(no)->op11->io
```

#### 流域产流计算

产流计算基本思路：流域上每点含水量达到田间持水量时产流，但是各个点的田间持水量和初始水量都是不同的，如何表达？采用了一种概率方式，利用流域蓄水容量曲线表示。整个流域有初始土壤含水量 W0，其空间分布在蓄水容量曲线上进行表达；PE 的值及其分布同样可以在曲线上表达；那么产流量就可在图上表示出来。计算公式如下：

- P-E+a < $W_{mm^{'}}$时
  R = PE-$\int_a^{PE+a}[1-\varphi(W_{m^{'}})]dW_{m^{'}} $ = P - E - $(W_m-W_0)+W_m(1-\frac{a+PE}{W_{mm^{'}}})^{1+b}$
- 当 P-E+a $\geqq W_{mm^{'}}$时
  R=P-E-$(W_m-W_0)$

因此，需要先根据流域初始含水量求出 a 值。这里也是为什么要提前多天计算模型开始计算时间的流域土壤含水量的原因，因为直接在模型起算时间计算时，计算蒸发需要知道 R，而计算 R 需要知道初始土壤含水量，而初始含水量未知，a 无法求，产流量不可知，无法计算蒸发，会形成死循环。而从多天前开始起算，保证前期有降雨使土壤含水量达到过田间持水量，或者长期干旱，流域蓄水量基本为 0，都便于后面的计算。
在经过前面的计算，已知起算时间流域含水量的情况下，可以根据下式求得 a 值：
a = ${W_{mm^{'}}}[1-(1-\frac{W_0}{W_m}^{\frac{1}{1+b}})]$

#### 水源划分

水源划分的原因在于后面汇流阶段不同径流成分的水滴其汇流表现不同，汇流时间不一样，因此需要区别处理。
这部分书上解释地不是太详细，大部分都只是在列公式，这里给出个人的理解，如下所述。

首先流域产流用的标志是流域上一点的土壤含水量超过田间持水量。接下来，对于流域而言，土壤好比**地下径流蓄水库**，遵循蓄满产流的定义，土壤在达到田间持水量之后，会直接补给地下水，直至该“水库”蓄满，然后蓄满产流，产生地表径流。而该“水库”蓄满的含义就是指产流区域上一点的水量达到或高于自由水蓄水容量，高出的部分就是地表径流。（这块和前面蒸发分几层没有关系，它们互相之间应该是不对应的，如果非认为有关系，可以认为和两层蒸发模型对应，三层蒸发模型描述的是一个土壤输移断裂的情况，两层的是有一个相对不透水层的情况，PE>0时，不管先补充哪一层补充的都是这里说的地下水水库）
而自由水蓄水容量在产流面积上分布也是不均匀的，考虑用和产流计算时同样的技巧，即用概率的方式表达，表达的形式和之前产流的方式是一致的————产流面积上的自由水蓄水容量曲线，那么就可以分出地表水和地下水了。
具体的表达如下：
$$\frac{FS}{FR}=1-(1-\frac{SMF^{'}}{SMMF})^{EX}$$
其中，SMF'、SMMF、EX、FS/FR分别表示产流面积上某一点的自由水蓄水容量，产流面积上最大的一点的自由水蓄水容量，流域自由水蓄水容量曲线的指数，产流面积上的各点自由水蓄水容量小于等于SMF'的流域面积 占产流面积的比例。**这里需要注意量纲问题**，前述容量均为水深量纲。
从上式可以推出(推导过程和产流计算时候的一致):
SMF=$\frac{SMMF}{1+EX}$，AU=SMMF$[1-(1-\frac{S}{SMF})^{\frac{1}{1+EX}}]$ 
其中，SMF表示产流面积上的自由水平均蓄水**容量**深，S表示自由水在产流面积上的平均蓄水深。

有了上述表达，就可以推求地面径流的表达式了。
在 FS/FR ~ SMF' 关系图中，S是平均的自由水蓄水水库水深，如果流域产流面积上对应的初始状态是AU，那么接下来当产流量即净雨增加时，在图上增加S对应的SMF'坐标上移，多出来的部分，在曲线左侧的就是地表径流RS了，在右侧的就是地下径流了。
那么现在问题的关键就在于在这样一个关系图中，纵坐标增量如何理解。
纵坐标的增量其实就是产流，即**净雨在产流面积上的表达**。可以认为是全流域的产流深折算到产流区域上的，即R_产流面积上 = R/FR（注意，FR指的是产流面积占流域总面积的比例），同时，在产流区域上，净雨直接可以由P-E表达，因此也可以得到R/FR=P-E=PE。自然地，在关系图上，增量都是在产流面积上表达的，所以如果用RS表示流域上的地表径流，那么在图上，代表地面径流的曲线左侧的增量部分应该也折算到产流面积上，即曲线左侧阴影面积应该是RS/FR。根据以上分析，可以有如下表达式：

- 当R/FR+AU<SMMF时，$$RS=FR*[PE-(SMF-S)+SMF(1-\frac{PE+AU}{SMMF})^{1+EX}]$$
- 当R/FR+AU>=SMMF时，$$RS=FR(PE-(SMF-S))$$

不过由于在做增量时，即流域上净雨增加时，流域上产流面积也增大了，也就是SMMF也可能上移了，所以最好尽量减少一次净雨的增量，使得差分计算的误差尽量小，书上推荐的是采用5mm净雨分一段。分段的时候，注意一个时段可能被分成几个部分，注意相关变量也要对应起来。

另外，在上述公式中，还存在几个未知量，包括产流面积FR，FR上的平均自由水深S，对应的AU，FR上的自由水平均蓄水容量深SMF，以及FR上最大一点的自由水蓄水容量深SMMF，所以现在问题就转换为如何求这些量。
因为计算产流的时候已经求得了产流的相关数据，因此产流面积易得；SMF与SMMF之间有固定关系表达（见前面公式），所以知道SMMF就可求得SMF；AU可由S求得，所以求出S即可。那么关键就是如何求SMMF和S了。S是可以设置初值（***TODO:如何设置?***）；而SMMF则通过另一条曲线来进行分析。
回到流域，定义流域产流面积上最大点自由蓄水容量与产流面积占总面积的比例之间的关系，同样为抛物线型。
$$FR=1-(1-\frac{SMMF}{SMM})^{EX}$$
则可以求得：SMMF=SMM[1-$(1-FR)^{\frac{1}{EX}}$]，且SMM=SM(1+EX)。
SM流域平均自由水蓄水容量和次幂EX，对一个流域来说，在计算中是定值，因此由流域模型参数来定义，根据资料进行率定。因此各个变量均可求得。

最后，还需要处理地下水流如何划分为壤中流和地下径流的问题。
自由水蓄水线性水库，按比例处理，自由水深×壤中流出流系数×FR，就得到壤中流；自由水深×地下径流出流系数×FR，就得到地下径流。
自由水深是产流面积上的自由水深，就是 FS/FR ~ SMF' 关系图中增量曲线右侧部分。
当PE+AU>=SMMF时，就是SMF，即产流面积上的平均自由水蓄水容量深；
当0<PE+AU<SMMF时，就是△S+S=PE-RS/FR+S。
注意它们都是产流面积上定义的，所以最后还得诚意FR，转换到流域层面上。最后计算S来为下一时段的计算准备，即计算时段末产流面积上的平均自由水深，那就是自由水蓄水库中水减去流失的水分，即产流面积上自由水深-（壤中流+地下径流）/FR（注：壤中流和地下径流要折算到产流面积上，所以除以FR）。

汇总以上分析，可以得到：

S设置初值，后面迭代计算。
SM和EX是模型参数。

FR=R/PE
SMM=SM(1+EX)
SMMF=SMM[1-$(1-FR)^{\frac{1}{EX}}$]
SMF=SMMF/(1+EX)
AU=SMMF[1-$(1-\frac{S}{SMF})^{\frac{1}{1+EX}}$]

- 当PE+AU>=SMMF时：
  RS=(PE+S-SMF)FR
  RSS=SMF·KSS·FR
  RG=SMF·KG·FR
  S=SMF-$\frac{RSS+RG}{FR}$
- 当0<PE+AU<SMMF时：
  RS={PE-SMF+s+SMF$[1-\frac{PE+AU}{SMMF}]^{EX+1}$}FR
  RSS=(PE-$\frac{RS}{FR}$+S)KSS·FR
  RG=(PE-$\frac{RS}{FR}$+S)KG·FR
  S=S+PE-$\frac{RS+RSS+RG}{FR}$
- PE+AU<=0时：
  RS=RSS=RG=S=0

最后特别说明：
以上量纲不是1的变量中，在流域上定义的有：R,SM,SMM,RS,RSS,RG；
在产流面积上定义的有：S,PE,SMMF,SMF,AU。

#### 坡地汇流

地下水线性水库模型。

#### 河网汇流

单位线以及河道演算。

### 模型参数率定

## 使用说明

直接运行test.py即可（**尚在开发中！！！**）

## 参与贡献

1. Fork 本项目
2. 新建 Feat_xxx 分支
3. 提交代码
4. 新建 Pull Request
